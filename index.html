<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Data Panel - Team Choochoochagachaga</title>
    <meta name="description" content="Frontend for Team Choochoochagachaga" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/lykmapipo/themify-icons@0.1.2/css/themify-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/pixeden-stroke-7-icon@1.2.3/pe-icon-7-stroke/dist/pe-icon-7-stroke.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.0/css/flag-icon.min.css"
    />
    <link rel="stylesheet" href="assets/css/cs-skin-elastic.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv.min.js"></script> -->
    <link
      href="https://cdn.jsdelivr.net/npm/chartist@0.11.0/dist/chartist.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/jqvmap@1.5.1/dist/jqvmap.min.css"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/weathericons@2.1.0/css/weather-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@3.9.0/dist/fullcalendar.min.css"
      rel="stylesheet"
    />

    <style>
      #weatherWidget .currentDesc {
        color: #ffffff !important;
      }
      .traffic-chart {
        min-height: 335px;
      }
      #flotPie1 {
        height: 150px;
      }
      #flotPie1 td {
        padding: 3px;
      }
      #flotPie1 table {
        top: 20px !important;
        right: -10px !important;
      }
      .chart-container {
        display: table;
        min-width: 270px;
        text-align: left;
        padding-top: 10px;
        padding-bottom: 10px;
      }
      #flotLine5 {
        height: 105px;
      }

      #flotBarChart {
        height: 150px;
      }
      #cellPaiChart {
        height: 160px;
      }
      #heatmapContainer {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body>
    <!-- Left Panel -->
    <aside id="left-panel" class="left-panel">
      <nav class="navbar navbar-expand-sm navbar-default">
        <div id="main-menu" class="main-menu collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active">
              <a href="index.html"
                ><i class="menu-icon fa fa-laptop"></i>Dashboard
              </a>
            </li>

            <li class="menu-title">Your Dossier</li>
            <!-- /.menu-title -->

            <li class="menu-item-has-children dropdown">
              <a
                href="#"
                class="dropdown-toggle"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                <i class="menu-icon fa fa-cogs"></i>Information</a
              >
              <ul class="sub-menu children dropdown-menu">
                <li>
                  <i class="fa fa-puzzle-piece"></i
                  ><a href="#">Details</a>
                </li>
                <li>
                  <i class="fa fa-id-badge"></i
                  ><a href="#">Sensors</a>
                </li>
              </ul>
            </li>

            <li class="menu-item-has-children dropdown">
              <a
                href="#"
                class="dropdown-toggle"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                <i class="menu-icon fa fa-table"></i>Vitals</a
              >
              <ul class="sub-menu children dropdown-menu">
                <li>
                  <i class="fa fa-table"></i
                  ><a href="#">At a glance</a>
                </li>
                <li>
                  <i class="fa fa-table"></i
                  ><a href="#">Hydration records</a>
                </li>
              </ul>
            </li>

            <li class="menu-item-has-children dropdown">
              <a
                href="#"
                class="dropdown-toggle"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                <i class="menu-icon fa fa-th"></i>Performance</a
              >
              <ul class="sub-menu children dropdown-menu">
                <li>
                  <i class="menu-icon fa fa-th"></i
                  ><a href="#">At a glance</a>
                </li>
                <li>
                  <i class="menu-icon fa fa-th"></i
                  ><a href="#">Detailed report</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </nav>
    </aside>
    <!-- /#left-panel -->
    <!-- Right Panel -->
    <div id="right-panel" class="right-panel">
      <!-- Header-->
      <header id="header" class="header">
        <div class="top-left">
          <div class="navbar-header">
            <a class="navbar-brand" href="./"
              ><img src="images/logo.png" alt="Logo"
            /></a>
            <a class="navbar-brand hidden" href="./"
              ><img src="images/logo2.png" alt="Logo"
            /></a>
            <a id="menuToggle" class="menutoggle"><i class="fa fa-bars"></i></a>
          </div>
        </div>
        <div class="top-right">
          <div class="header-menu">
            <div class="header-left">
              <button class="search-trigger">
                <i class="fa fa-search"></i>
              </button>
              <div class="form-inline">
                <form class="search-form">
                  <input
                    class="form-control mr-sm-2"
                    type="text"
                    placeholder="Search ..."
                    aria-label="Search"
                  />
                  <button class="search-close" type="submit">
                    <i class="fa fa-close"></i>
                  </button>
                </form>
              </div>

            <div class="user-area dropdown float-right">
              <a
                href="#"
                class="dropdown-toggle active"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                <img
                  class="user-avatar rounded-circle"
                  src="images/admin.jpg"
                  alt="User Avatar"
                />
              </a>
            </div>
          </div>
        </div>
      </header>
      <!-- /#header -->
      <!-- Content -->
      <div class="content">
        <!-- Animated -->
        <div class="animated fadeIn">
          <!-- Widgets  -->
          <div class="row">
            <div class="col-lg-6">
              <div class="card">
                <div class="card-body">
                  <div class="stat-widget-five">
                    <div class="stat-icon dib flat-color-1">
                      <i class="pe-7s-timer"></i>
                    </div>
                    <div class="stat-content">
                      <div class="text-left dib">
                        <div class="stat-text" id="timeTaken">
                          59 mins 30 secs
                        </div>
                        <div class="stat-heading">Time taken</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-6">
              <div class="card">
                <div class="card-body">
                  <div class="stat-widget-five">
                    <div class="stat-icon dib flat-color-2">
                      <i class="pe-7s-graph3"></i>
                    </div>
                    <div class="stat-content">
                      <div class="text-left dib">
                        <div class="stat-text" id="sensorStatus" style="color: green;">
                          <strong>Enabled</strong>
                        </div>
                        <div class="stat-heading">Sensor status</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- /Widgets -->

          <!--  Vitals  -->
          <!-- <div class="row">
            <div class="col-lg-6">
              <div class="card">
                <div class="card-body">
                  <h4 class="box-title">Heart Rate</h4>
                </div>
                <div class="card-body">
                    <canvas id="heartRate"></canvas>
                </div>
              </div>
            </div>

            <div class="col-lg-6">
              <div class="card">
                <div class="card-body">
                  <h4 class="box-title">Body Temperature</h4>
                </div>
                <div class="card-body">
                    <canvas id="bodyTemp"></canvas>
                </div>
              </div>
            </div>
          </div> -->

          <div class="col-lg-12">
            <div class="card">
              <div class="card-body">
                <h4 class="box-title">Heart Rate</h4>
              </div>
              <div class="card-body">
                  <canvas id="heartRate"></canvas>
                  <!-- <div id="traffic-chart" class="traffic-chart"></div> -->
              </div>
            </div>

            <div class="col-lg-12">
              <div class="card">
                <div class="card-body">
                  <h4 class="box-title">Temperature</h4>
                </div>
                <div class="card-body">
                    <canvas id="Temp"></canvas>
                </div>
              </div>
            </div>
          
          <!--  /Vitals -->

          

          <div class="clearfix"></div>
          
          <!-- heatmap -->
          <div class="col-lg-12">
            <div class="card">
              <div class="card-body">
                <h4 class="box-title">Location Heat Map</h4>
              </div>
              <div class="card-body">
                <div id="heatmapContainer">
                  <img src="/images/sutd-map.jpg">
                </div>
              </div>
            </div>
          </div>
          <!-- /heatmap -->
      </div>
      <!-- /.content -->
      <div class="clearfix"></div>
      <!-- Footer -->
      <footer class="site-footer">
        <div class="footer-inner bg-white">
          <div class="row">
            <div class="col-sm-6">
              Adapted from ColorLib ElaAdmin Template
            </div>
      </footer>
      <!-- /.site-footer -->
    </div>
    <!-- /#right-panel -->

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-match-height@0.7.2/dist/jquery.matchHeight.min.js"></script>
    <script src="assets/js/main.js"></script>

    <!--  Chart js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.7.3/dist/Chart.bundle.min.js"></script>

    <!--Chartist Chart-->
    <script src="https://cdn.jsdelivr.net/npm/chartist@0.11.0/dist/chartist.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartist-plugin-legend@0.6.2/chartist-plugin-legend.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/jquery.flot@0.8.3/jquery.flot.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flot-pie@1.0.0/src/jquery.flot.pie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flot-spline@0.0.1/js/jquery.flot.spline.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/simpleweather@3.1.0/jquery.simpleWeather.min.js"></script>
    <script src="assets/js/init/weather-init.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@3.9.0/dist/fullcalendar.min.js"></script>
    <script src="assets/js/init/fullcalendar-init.js"></script>

    <!-- heatmap -->
    <script src="/assets/js/heatmap.min.js"></script>

    <!--Local Stuff-->
    <script>
      // Pulling data from the database
      // Have configured it to be not an asynchronous process
      const account = "adef00a8-b0a0-4d14-8305-6be0563ed542-bluemix";
      const api_key = "4aQghGIAIrBzsJRx2fbspghgtQXPWLTfmvZKpetOaO7K";
      const cors_proxy = "https://cors-anywhere.herokuapp.com/";
      var iamRequest = new XMLHttpRequest();
      var finalResponse;

      iamRequest.open("POST", cors_proxy + "https://iam.cloud.ibm.com/identity/token", false);
      // iamRequest.setRequestHeader("Allow-Control-Access-Origin", "http://127.0.0.1:5500");
      iamRequest.setRequestHeader("Accept", "application/json");
      iamRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      iamRequest.send("grant_type=urn:ibm:params:oauth:grant-type:apikey&response_type=cloud_iam&apikey=" + api_key);
      var response = JSON.parse(iamRequest.responseText);
      var access_token = response['access_token']; // IAM token obtained. Store permanently to be used throughout the rest of the script

      function DataBaseQuery(iam, selector, async=false) {
        iam.open("POST", cors_proxy + "https://" + account + ".cloudantnosqldb.appdomain.cloud/smart_environment/_find", async);
        iam.setRequestHeader("Content-type", "application/json");
        // iam.setRequestHeader("Accept", "application/json");
        iam.setRequestHeader("Authorization", "Bearer " + access_token);
        iam.send(JSON.stringify(selector));
        finalResponse = JSON.parse(iam.responseText);
        return finalResponse;
      }
      var data = DataBaseQuery(iamRequest, {"selector": {
                                                  "_id": {
                                                    "$gt": 0
                                                  }
                                              },
                                              "fields": [
                                                  "info",
                                              ]
                                            }, false);
      // iamRequest.onreadystatechange(function(data) 
      var BATCH_NUMBER = 0;
      var PERSON = 0;
      
      function GetBatch(idx) {
        return data['docs'][idx];
      }

      function GetBatchNumbers(idx) {
        return data['batch'][idx];
      }

      function GetPerson(batch, idx) {
        return batch['info'][idx];
      }

      var person = GetPerson(GetBatch(BATCH_NUMBER), PERSON);
      //console.log(person)

      //info_str can include altitude, bpm, location (in array), names, temperature, time
      function GetPersonStats(person_info, info_str) {
        /*
        # {"basic_info": [{"name": , "age": , "height": , "weight": , "load": , "specs": , "exp": , "qual": , "ippt": }
        */
       var persons_stats = new Array();
       for (i = 0; i < person_info.length; i++) {
         persons_stats.push(person_info[i][info_str]);
       }
       return persons_stats
      }
      //console.log(GetPersonStats(person, "location"));
      // });

      // const username = "adef00a8-b0a0-4d14-8305-6be0563ed542-bluemix";
      // const Http = new XMLHttpRequest();
      // var url = 'https://' + username + '.cloudant.com/smart_environment/_all_docs';
      // Http.open("GET", url);
      // Http.send();

      // Http.onreadystatechange = (e) => {
      //   console.log(Http.responseText)
      // }

      //clean time
      function getTimeLabels() {
        var timeArr = GetPersonStats(person, "time");
        var i;
        var firstVal = timeArr[0];
        for (i=0; i < timeArr.length; i++) {
          timeArr[i] -= firstVal;
        }
        return timeArr;
      }
      var timeLabels = getTimeLabels();

      //clean location
      function getLocationLabels() {
        var finalLocationArr = [];
        var locationArr = GetPersonStats(person, "location");
        var i; 
        for (i=0; i < locationArr.length; i++) {
          var dict = {};
          dict['x'] = Math.abs(locationArr[i][0]) * Math.random() * 100;
          dict['y'] = Math.abs(locationArr[i][1]) * Math.random() * 100;
          dict['radius'] = 30;
          finalLocationArr.push(dict);
        }
        return finalLocationArr;
      }
      var locationLabels = getLocationLabels();

      jQuery(document).ready(function ($) {
        "use strict";

        //heatmap
        var heatmap = h337.create({
          container: document.getElementById('heatmapContainer'),
          // a waterdrop gradient ;-)
          gradient: { .1: 'rgba(0,153,153, .2)', 0.25: "rgb(0,153,153)", .6: "rgb(255,153,0)", .95: 'rgb(179,0,0)'},
          maxOpacity: .6,
          radius: 10,
        });
        heatmap.addData(locationLabels);

        // boundaries for data generation
        // var width = (+window.getComputedStyle(document.body).width.replace(/px/,''));
        // var height = (+window.getComputedStyle(document.body).height.replace(/px/,''));

        // var generate = function() {

        //   var x = (Math.random()* width) >> 0;
        //   var y = (Math.random()* height) >> 0;
        //   var r = (Math.random()* 100) >> 0;

        //   console.log(x,y,r);

        //   // add the datapoint to heatmap instance
        //   heatmap.addData({ x: x, y:y, radius: r});
        // };

        // // this generates new datapoints in a kind of random timing
        // setTimeout(function test() {
        //   var rand = (Math.random() * 500) >> 0;
        //   generate();
        //   setTimeout(test, rand);
        // }, 100);
        // end heatmap


        // Traffic Chart using chartist
        if ($("#traffic-chart").length) {
          var chart = new Chartist.Line(
            "#traffic-chart",
            {
              labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
              series: [
                [0, 18000, 35000, 25000, 22000, 0],
                [0, 33000, 15000, 20000, 15000, 300],
                [0, 15000, 28000, 15000, 30000, 5000],
              ],
            },
            {
              low: 0,
              showArea: true,
              showLine: false,
              showPoint: false,
              fullWidth: true,
              axisX: {
                showGrid: true,
              },
            }
          );

          chart.on("draw", function (data) {
            if (data.type === "line" || data.type === "area") {
              data.element.animate({
                d: {
                  begin: 2000 * data.index,
                  dur: 2000,
                  from: data.path
                    .clone()
                    .scale(1, 0)
                    .translate(0, data.chartRect.height())
                    .stringify(),
                  to: data.path.clone().stringify(),
                  easing: Chartist.Svg.Easing.easeOutQuint,
                },
              });
            }
          });
        }
        // Traffic Chart using chartist End
        
        //heart rate graphing
        if ($("#heartRate").length) {
          var ctx = document.getElementById("heartRate");
          ctx.height = 150;
          var myChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: timeLabels,
              datasets: [
                {
                  label: "Heart Rate",
                  borderColor: "rgba(4, 73, 203, 1)",
                  borderWidth: "1",
                  data: GetPersonStats(person, "bpm"),
                  lineTension: 0,
                },
                // {
                //   label: "Bounce",
                //   borderColor: "rgba(245, 23, 66, 0.9)",
                //   borderWidth: "1",
                //   backgroundColor: "rgba(245, 23, 66,.5)",
                //   pointHighlightStroke: "rgba(245, 23, 66,.5)",
                //   data: [0, 4200, 4500, 1600, 4200, 1500, 4000],
                // },
                // {
                //   label: "Targeted",
                //   borderColor: "rgba(40, 169, 46, 0.9)",
                //   borderWidth: "1",
                //   backgroundColor: "rgba(40, 169, 46, .5)",
                //   pointHighlightStroke: "rgba(40, 169, 46,.5)",
                //   data: [1000, 5200, 3600, 2600, 4200, 5300, 0],
                // },
              ],
            },
            options: {
              responsive: true,
              tooltips: {
                mode: "index",
                intersect: false,
              },
              hover: {
                mode: "nearest",
                intersect: true,
              },
            //   scales: {
            //       yAxes: [{
            //           ticks: {
            //               min: -10,
            //               max: 200,
            //           }
            //       }]
            //   }
            },
          });
        }
        //end heart rate

        //body temp graph
        if ($("#Temp").length) {
          var ctx = document.getElementById("Temp");
          ctx.height = 150;
          var myChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: timeLabels,
              datasets: [
                {
                  label: "Body Temp.",
                  borderColor: "rgba(4, 73, 203, 1)",
                  borderWidth: "1",
                  data: GetPersonStats(person, "temperature"),
                  lineTension: 0,
                },
              ],
            },
            options: {
              responsive: true,
              tooltips: {
                mode: "index",
                intersect: false,
              },
              hover: {
                mode: "nearest",
                intersect: true,
              },
            },
          });
        }
        //end body temp

        // Bar Chart #flotBarChart
        $.plot(
          "#flotBarChart",
          [
            {
              data: [
                [0, 18],
                [2, 8],
                [4, 5],
                [6, 13],
                [8, 5],
                [10, 7],
                [12, 4],
                [14, 6],
                [16, 15],
                [18, 9],
                [20, 17],
                [22, 7],
                [24, 4],
                [26, 9],
                [28, 11],
              ],
              bars: {
                show: true,
                lineWidth: 0,
                fillColor: "#ffffff8a",
              },
            },
          ],
          {
            grid: {
              show: false,
            },
          }
        );
        // Bar Chart #flotBarChart End
      });
    </script>
  </body>
</html>
